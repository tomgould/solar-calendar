<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solar Calendar with Gregorian Dates</title>
  <link rel="stylesheet" href="calendar-styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>🌞 Solar Calendar with Gregorian Dates</h1>
      <div class="controls">
        <div class="control-group">
          <label for="year-input">Year:</label>
          <input type="number" id="year-input" min="1900" max="2100" />
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">
          <span id="theme-icon">🌙</span>
          <span id="theme-text">Dark Mode</span>
        </button>
      </div>
    </header>

    <div class="nav-controls">
      <button class="nav-btn" id="prev-btn" onclick="navigateMonth(-1)">
        ◀ Previous
      </button>
      <div class="month-indicator" id="current-month-indicator">Month 1</div>
      <button class="nav-btn" id="next-btn" onclick="navigateMonth(1)">
        Next ▶
      </button>
    </div>

    <div class="astronomical-events" id="astronomical-events"></div>

    <div id="calendar-container"></div>
  </div>

  <script src="calendar-processor.js"></script>
  <script>
    const calendarProcessor = new CalendarProcessor();
    let currentMonth = 0;
    let selectedYear = new Date().getFullYear();

    function displayAstronomicalEvents() {
      const events = calendarProcessor.getAstronomicalEvents(selectedYear);
      const container = document.getElementById('astronomical-events');
      
      const eventData = [
        {
          key: 'vernalEquinox',
          title: '🌱 Vernal Equinox',
          class: 'vernal',
          description: 'Spring begins - Equal day and night',
          time: '~05:00 UTC'
        },
        {
          key: 'summerSolstice',
          title: '☀️ Summer Solstice',
          class: 'summer',
          description: 'Longest day of the year',
          time: '~21:00 UTC'
        },
        {
          key: 'autumnEquinox',
          title: '🍂 Autumn Equinox',
          class: 'autumn',
          description: 'Fall begins - Equal day and night',
          time: '~07:00 UTC'
        },
        {
          key: 'winterSolstice',
          title: '❄️ Winter Solstice',
          class: 'winter',
          description: 'Shortest day of the year',
          time: '~03:00 UTC'
        }
      ];
      
      container.innerHTML = eventData.map(event => {
        const date = events[event.key];
        if (!date) return '';
        
        const monthName = calendarProcessor.gregorianMonths[date.getMonth()];
        const day = date.getDate();
        const dayName = calendarProcessor.dayNames[date.getDay()];
        
        return `
          <div class="astro-event ${event.class}" onclick="navigateToEvent('${event.key}')">
            <div class="astro-event-icon">${event.title.split(' ')[0]}</div>
            <div class="astro-event-title">${event.title.substring(3)}</div>
            <div class="astro-event-date">${dayName}, ${monthName} ${day}, ${selectedYear}</div>
            <div class="astro-tooltip">
              ${event.description}<br>
              <small>${event.time}</small>
            </div>
          </div>
        `;
      }).join('');
    }

    function navigateToEvent(eventKey) {
      const events = calendarProcessor.getAstronomicalEvents(selectedYear);
      const eventDate = events[eventKey];
      if (!eventDate) return;
      
      // Find which solar month this date falls in
      const solarDate = calendarProcessor.getSolarDateFromGregorian(eventDate, selectedYear);
      if (!solarDate) return;
      
      currentMonth = solarDate.monthIndex;
      updateDisplay();
      
      // Highlight the specific day
      setTimeout(() => {
        const eventDateStr = calendarProcessor.toISODateString(eventDate);
        const dayElement = document.querySelector(`[data-gregorian-date="${eventDateStr}"]`);
        if (dayElement) {
          dayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          dayElement.style.animation = 'none';
          setTimeout(() => {
            dayElement.style.animation = 'pulse 1s ease-in-out 3';
          }, 10);
        }
      }, 100);
    }

    function formatDate(date) {
      const month = calendarProcessor.gregorianMonths[date.getMonth()];
      const day = date.getDate();
      const dayName = calendarProcessor.dayNames[date.getDay()];
      return { month, day, dayName };
    }

    function generateCalendar() {
      const container = document.getElementById('calendar-container');
      container.innerHTML = '';

      const today = new Date();
      const todayStr = calendarProcessor.toISODateString(today);

      calendarProcessor.solarMonths.forEach((month, monthIndex) => {
        const monthDiv = document.createElement('div');
        monthDiv.className = 'month';
        monthDiv.id = `month-${monthIndex}`;

        const monthTitle = document.createElement('h2');
        monthTitle.className = 'month-link';
        monthTitle.style.cursor = 'pointer';
        
        const titleData = calendarProcessor.formatSolarMonthTitle(monthIndex);
        monthTitle.innerHTML = `
          <span class="month-title-main">${titleData.main}</span>
          <span class="month-title-sub">${titleData.sub}</span>
        `;
        
        // Add click handler to navigate to corresponding Gregorian month
        monthTitle.addEventListener('click', () => {
          // Get the first gregorian month for this solar month
          const gregorianMonthName = month.gregorianMonths[0];
          const gregorianMonthIndex = calendarProcessor.gregorianMonths.indexOf(gregorianMonthName);
          window.location.href = `gregorian-calendar.html?month=${gregorianMonthIndex}&year=${selectedYear}`;
        });
        
        monthDiv.appendChild(monthTitle);

        const calendar = document.createElement('div');
        calendar.className = 'calendar';

        calendarProcessor.dayNames.forEach(day => {
          const header = document.createElement('div');
          header.className = 'header';
          header.textContent = day;
          calendar.appendChild(header);
        });

        const firstDay = calendarProcessor.getGregorianDateForSolarDay(selectedYear, month.startDay);
        if (firstDay) {
          const firstDayOfWeek = firstDay.getDay();

          for (let i = 0; i < firstDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'day empty';
            calendar.appendChild(emptyDay);
          }

          for (let day = 1; day <= month.days; day++) {
            const solarDay = month.startDay + day - 1;
            const gregorianDate = calendarProcessor.getGregorianDateForSolarDay(selectedYear, solarDay);

            if (gregorianDate) {
              const dayDiv = document.createElement('div');
              dayDiv.className = 'day';

              const gregorianDateStr = calendarProcessor.toISODateString(gregorianDate);
              dayDiv.setAttribute('data-gregorian-date', gregorianDateStr);

              if (gregorianDateStr === todayStr) {
                dayDiv.classList.add('today');
              }

              const astroEvent = calendarProcessor.checkAstronomicalEvent(gregorianDate, selectedYear);
              if (astroEvent) {
                dayDiv.classList.add(astroEvent.class);
                const badge = document.createElement('div');
                badge.className = 'astro-badge';
                badge.textContent = astroEvent.icon;
                dayDiv.appendChild(badge);
              }

              const dayNumber = document.createElement('div');
              dayNumber.className = 'day-number';
              dayNumber.textContent = day;
              dayDiv.appendChild(dayNumber);

              const { month: gMonth, day: gDay, dayName } = formatDate(gregorianDate);
              const gregorianInfo = document.createElement('div');
              gregorianInfo.className = 'gregorian-date';
              gregorianInfo.innerHTML = `${gMonth} ${gDay}`;
              dayDiv.appendChild(gregorianInfo);

              const monthInfo = document.createElement('div');
              monthInfo.className = 'gregorian-month';
              monthInfo.textContent = dayName;
              dayDiv.appendChild(monthInfo);

              // Add click handler to link to gregorian calendar
              dayDiv.style.cursor = 'pointer';
              dayDiv.addEventListener('click', () => {
                window.location.href = `gregorian-calendar.html?date=${gregorianDateStr}&year=${selectedYear}`;
              });

              calendar.appendChild(dayDiv);
            }
          }
        }

        monthDiv.appendChild(calendar);
        container.appendChild(monthDiv);
      });

      displayAstronomicalEvents();
    }

    function updateDisplay() {
      document.querySelectorAll('.month').forEach((month, index) => {
        month.classList.toggle('active', index === currentMonth);
      });

      const monthData = calendarProcessor.solarMonths[currentMonth];
      document.getElementById('current-month-indicator').textContent = 
        `${monthData.englishName} (${monthData.persianName})`;

      document.getElementById('prev-btn').disabled = currentMonth === 0;
      document.getElementById('next-btn').disabled = currentMonth === calendarProcessor.solarMonths.length - 1;

      displayAstronomicalEvents();
    }

    function navigateMonth(direction) {
      const newMonth = currentMonth + direction;
      if (newMonth >= 0 && newMonth < calendarProcessor.solarMonths.length) {
        currentMonth = newMonth;
        updateDisplay();
        document.getElementById(`month-${currentMonth}`).scrollIntoView({ 
          behavior: 'smooth',
          block: 'start'
        });
      }
    }

    function updateYear() {
      const yearInput = document.getElementById('year-input');
      const newYear = parseInt(yearInput.value);

      if (newYear >= 1900 && newYear <= 2100) {
        selectedYear = newYear;
        currentMonth = 0;
        generateCalendar();
        updateDisplay();
      } else {
        alert('Please enter a year between 1900 and 2100');
        yearInput.value = selectedYear;
      }
    }

    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', newTheme);
      
      const icon = document.getElementById('theme-icon');
      const text = document.getElementById('theme-text');
      
      if (newTheme === 'dark') {
        icon.textContent = '☀️';
        text.textContent = 'Light Mode';
      } else {
        icon.textContent = '🌙';
        text.textContent = 'Dark Mode';
      }
      
      localStorage.setItem('theme', newTheme);
    }

    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      const icon = document.getElementById('theme-icon');
      const text = document.getElementById('theme-text');
      
      if (savedTheme === 'dark') {
        icon.textContent = '☀️';
        text.textContent = 'Light Mode';
      }
    }

    // Handle URL parameters for cross-calendar navigation
    function handleURLParameters() {
      const urlParams = new URLSearchParams(window.location.search);
      const targetMonth = urlParams.get('month');
      const targetDate = urlParams.get('date');
      
      if (targetMonth !== null) {
        const monthIndex = parseInt(targetMonth);
        if (monthIndex >= 0 && monthIndex < calendarProcessor.solarMonths.length) {
          currentMonth = monthIndex;
        }
      } else if (targetDate) {
        const date = new Date(targetDate);
        if (!isNaN(date.getTime())) {
          const solarDate = calendarProcessor.getSolarDateFromGregorian(date, selectedYear);
          if (solarDate) {
            currentMonth = solarDate.monthIndex;
            
            setTimeout(() => {
              const dayElement = document.querySelector(`[data-gregorian-date="${targetDate}"]`);
              if (dayElement) {
                dayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                dayElement.style.animation = 'pulse 1s ease-in-out 3';
              }
            }, 500);
          }
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeTheme();
      const yearInput = document.getElementById('year-input');
      yearInput.value = selectedYear;
      yearInput.addEventListener('change', updateYear);
      yearInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') updateYear();
      });

      generateCalendar();
      handleURLParameters();
      updateDisplay();
    });
  </script>
</body>
</html>
