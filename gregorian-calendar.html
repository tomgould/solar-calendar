<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gregorian Calendar with Solar Dates</title>
  <link rel="stylesheet" href="calendar-styles.css">
  <style>
    /* Additional styles specific to Gregorian calendar */
    .day-ordinal {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.3rem;
    }

    .day-label {
      font-size: 0.65rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.2rem;
    }

    .day-solar {
      font-size: 0.7rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .solar-info {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      margin-top: 0.5rem;
    }

    .solar-month-name {
      font-weight: 600;
      color: var(--accent-primary);
    }

    .solar-day-number {
      color: var(--text-secondary);
    }

    @media (max-width: 768px) {
      .day-ordinal {
        font-size: 0.9rem;
      }
      .day-label {
        font-size: 0.6rem;
      }
      .day-solar {
        font-size: 0.65rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ“… Gregorian Calendar</h1>
      <div class="controls">
        <div class="control-group">
          <label for="year-input">Year:</label>
          <input type="number" id="year-input" min="1900" max="2100" />
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">
          <span id="theme-icon">ðŸŒ™</span>
          <span id="theme-text">Dark Mode</span>
        </button>
      </div>
    </header>

    <div class="nav-controls">
      <button class="nav-btn" id="prev-year-btn" onclick="navigateYear(-1)">
        â—€â—€ Year
      </button>
      <button class="nav-btn" id="prev-btn" onclick="navigateMonth(-1)">
        â—€ Month
      </button>
      <div class="month-indicator" id="current-month-indicator">January</div>
      <button class="nav-btn" id="next-btn" onclick="navigateMonth(1)">
        Month â–¶
      </button>
      <button class="nav-btn" id="next-year-btn" onclick="navigateYear(1)">
        Year â–¶â–¶
      </button>
    </div>

    <div class="astronomical-events" id="astronomical-events"></div>

    <div id="calendar-container"></div>
  </div>

  <script src="calendar-processor.js"></script>
  <script>
    const calendarProcessor = new CalendarProcessor();
    let currentMonth = 0;
    let selectedYear = new Date().getFullYear();

    function displayAstronomicalEvents() {
      const events = calendarProcessor.getAstronomicalEvents(selectedYear);
      const container = document.getElementById('astronomical-events');
      
      const eventData = [
        {
          key: 'vernalEquinox',
          title: 'ðŸŒ± Vernal Equinox',
          class: 'vernal',
          description: 'Spring begins',
          time: 'Solar New Year'
        },
        {
          key: 'summerSolstice',
          title: 'â˜€ï¸ Summer Solstice',
          class: 'summer',
          description: 'Longest day',
          time: 'Mid-Summer'
        },
        {
          key: 'autumnEquinox',
          title: 'ðŸ‚ Autumn Equinox',
          class: 'autumn',
          description: 'Fall begins',
          time: 'Mid-Fall'
        },
        {
          key: 'winterSolstice',
          title: 'â„ï¸ Winter Solstice',
          class: 'winter',
          description: 'Shortest day',
          time: 'Mid-Winter'
        }
      ];
      
      container.innerHTML = eventData.map(event => {
        const date = events[event.key];
        if (!date) return '';
        
        const monthName = calendarProcessor.gregorianMonths[date.getUTCMonth()];
        const day = date.getUTCDate();
        const dayName = calendarProcessor.dayNames[date.getUTCDay()];
        
        return `
          <div class="astro-event ${event.class}" onclick="navigateToEvent('${event.key}')">
            <div class="astro-event-icon">${event.title.split(' ')[0]}</div>
            <div class="astro-event-title">${event.title.substring(3)}</div>
            <div class="astro-event-date">${dayName}, ${monthName} ${day}</div>
            <div class="astro-tooltip">
              ${event.description}<br>
              <small>${event.time}</small>
            </div>
          </div>
        `;
      }).join('');
    }

    function navigateToEvent(eventKey) {
      const events = calendarProcessor.getAstronomicalEvents(selectedYear);
      const eventDate = events[eventKey];
      if (!eventDate) return;
      
      currentMonth = eventDate.getUTCMonth();
      updateDisplay();
      
      // Scroll and highlight the specific day
      setTimeout(() => {
        const eventDateStr = calendarProcessor.toISODateString(eventDate);
        const dayElement = document.querySelector(`[data-gregorian-date="${eventDateStr}"]`);
        if (dayElement) {
          dayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          dayElement.style.animation = 'pulse 1s ease-in-out 3';
        }
      }, 100);
    }

    function getOrdinalSuffix(day) {
      const j = day % 10, k = day % 100;
      if (j == 1 && k != 11) return "st";
      if (j == 2 && k != 12) return "nd";
      if (j == 3 && k != 13) return "rd";
      return "th";
    }

    function generateCalendar() {
      const container = document.getElementById('calendar-container');
      container.innerHTML = '';

      const today = new Date();
      const todayStr = calendarProcessor.toISODateString(today);

      for (let month = 0; month < 12; month++) {
        const monthDiv = document.createElement('div');
        monthDiv.className = 'month';
        monthDiv.id = `month-${month}`;

        // Add day headers
        calendarProcessor.dayNames.forEach(day => {
          const header = document.createElement('div');
          header.className = 'header';
          header.textContent = day;
          monthDiv.appendChild(header);
        });

        // Calculate days
        const monthStart = new Date(Date.UTC(selectedYear, month, 1));
        const daysInMonth = new Date(selectedYear, month + 1, 0).getDate();
        const startDay = monthStart.getUTCDay(); // 0 = Sun, 1 = Mon...

        // Empty cells before month starts
        for (let i = 0; i < startDay; i++) {
          const emptyDay = document.createElement('div');
          emptyDay.className = 'day empty';
          monthDiv.appendChild(emptyDay);
        }

        // Days of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dayDiv = document.createElement('div');
          dayDiv.className = 'day';
          
          const gregorianDate = new Date(Date.UTC(selectedYear, month, day));
          const gregorianDateStr = calendarProcessor.toISODateString(gregorianDate);
          dayDiv.setAttribute('data-gregorian-date', gregorianDateStr);

          // Check if today
          if (gregorianDateStr === todayStr) {
            dayDiv.classList.add('today');
          }

          // Check for astronomical events
          const astroEvent = calendarProcessor.checkAstronomicalEvent(gregorianDate, selectedYear);
          if (astroEvent) {
            dayDiv.classList.add(astroEvent.class);
            const badge = document.createElement('div');
            badge.className = 'astro-badge';
            badge.textContent = astroEvent.icon;
            dayDiv.appendChild(badge);
          }

          // Get solar date information
          const solarDate = calendarProcessor.getSolarDateFromGregorian(gregorianDate, selectedYear);

          // Build day content
          const dayNumber = document.createElement('div');
          dayNumber.className = 'day-ordinal';
          dayNumber.textContent = `${day}`; // Removed ordinal for cleaner look ${getOrdinalSuffix(day)}
          dayDiv.appendChild(dayNumber);

          // Solar information
          if (solarDate) {
            const solarInfo = document.createElement('div');
            solarInfo.className = 'solar-info';
            
            const label = document.createElement('div');
            label.className = 'day-label';
            label.textContent = 'Solar:';
            solarInfo.appendChild(label);

            const solarDetails = document.createElement('div');
            solarDetails.className = 'day-solar';
            solarDetails.innerHTML = `
              <span class="solar-month-name">${solarDate.persianName}</span>
              <span class="solar-day-number">${solarDate.day}</span>
            `;
            solarInfo.appendChild(solarDetails);

            dayDiv.appendChild(solarInfo);
          }

          // Add click handler for linking
          dayDiv.style.cursor = 'pointer';
          dayDiv.addEventListener('click', () => {
            window.location.href = `solar-calendar.html?date=${gregorianDateStr}&year=${selectedYear}`;
          });

          monthDiv.appendChild(dayDiv);
        }

        container.appendChild(monthDiv);
      }

      displayAstronomicalEvents();
    }

    function updateDisplay() {
      document.querySelectorAll('.month').forEach((month, index) => {
        month.classList.toggle('active', index === currentMonth);
      });

      const titleData = calendarProcessor.formatGregorianMonthTitle(currentMonth);
      document.getElementById('current-month-indicator').innerHTML = `
        <span class="month-title-main">${titleData.main}</span>
        <span class="month-title-sub">${titleData.sub}</span>
      `;

      displayAstronomicalEvents();
    }

    function navigateMonth(direction) {
      let newMonth = currentMonth + direction;

      if (newMonth < 0) {
        // Wrap to previous year
        newMonth = 11;
        selectedYear--;
        document.getElementById('year-input').value = selectedYear;
        generateCalendar(); // Regenerate for new year
      } else if (newMonth >= 12) {
        // Wrap to next year
        newMonth = 0;
        selectedYear++;
        document.getElementById('year-input').value = selectedYear;
        generateCalendar(); // Regenerate for new year
      }

      currentMonth = newMonth;
      updateDisplay();
    }

    function navigateYear(direction) {
      const yearInput = document.getElementById('year-input');
      let newYear = parseInt(yearInput.value) + direction;
      
      if (newYear < 1900) newYear = 1900;
      if (newYear > 2100) newYear = 2100;
      
      yearInput.value = newYear;
      updateYear(); // This already handles regeneration
    }

    function updateYear() {
      const yearInput = document.getElementById('year-input');
      let newYear = parseInt(yearInput.value);

      if (newYear < 1900) {
        newYear = 1900;
        yearInput.value = newYear;
      }
      if (newYear > 2100) {
        newYear = 2100;
        yearInput.value = newYear;
      }

      if (newYear >= 1900 && newYear <= 2100) {
        selectedYear = newYear;
        currentMonth = 0; // Reset to first month
        generateCalendar();
        updateDisplay();
      } else {
        yearInput.value = selectedYear;
      }
    }

    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', newTheme);
      
      const icon = document.getElementById('theme-icon');
      const text = document.getElementById('theme-text');
      
      if (newTheme === 'dark') {
        icon.textContent = 'â˜€ï¸';
        text.textContent = 'Light Mode';
      } else {
        icon.textContent = 'ðŸŒ™';
        text.textContent = 'Dark Mode';
      }
      
      localStorage.setItem('theme', newTheme);
    }

    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      const icon = document.getElementById('theme-icon');
      const text = document.getElementById('theme-text');
      
      if (savedTheme === 'dark') {
        icon.textContent = 'â˜€ï¸';
        text.textContent = 'Light Mode';
      }
    }

    // Handle URL parameters for cross-calendar navigation
    function handleURLParameters() {
      const urlParams = new URLSearchParams(window.location.search);
      const targetDate = urlParams.get('date');
      const targetMonth = urlParams.get('month');
      const targetYear = urlParams.get('year');

      if (targetYear) {
        let year = parseInt(targetYear);
        if (year >= 1900 && year <= 2100) {
          selectedYear = year;
          document.getElementById('year-input').value = selectedYear;
        }
      }
      
      if (targetMonth !== null) {
        const monthIndex = parseInt(targetMonth);
        if (monthIndex >= 0 && monthIndex < 12) {
          currentMonth = monthIndex;
        }
      } else if (targetDate) {
        const date = new Date(targetDate + "T00:00:00Z"); // Treat date as UTC
        if (!isNaN(date.getTime())) {
          currentMonth = date.getUTCMonth();
          selectedYear = date.getUTCFullYear();
          document.getElementById('year-input').value = selectedYear;
          
          setTimeout(() => {
            const dayElement = document.querySelector(`[data-gregorian-date="${targetDate}"]`);
            if (dayElement) {
              dayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
              dayElement.style.animation = 'pulse 1s ease-in-out 3';
            }
          }, 500);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      initializeTheme();
      
      // Load accurate equinox data before building calendar
      await calendarProcessor.loadVernalEquinoxData();

      const yearInput = document.getElementById('year-input');
      yearInput.value = selectedYear;
      yearInput.addEventListener('change', updateYear);
      yearInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault(); // Prevent form submission
          updateYear();
        }
      });

      handleURLParameters(); // Set year/month/date *before* first generate
      generateCalendar();
      updateDisplay();
    });
  </script>
</body>
</html>

